name: Release

on:
  release:
    types: [published]

permissions:
  id-token: write  # Required for OIDC trusted publishing
  contents: read

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Verify build output
        run: |
          echo "âœ… Verifying build artifacts..."
          test -f dist/cli.js || (echo "âŒ Error: dist/cli.js not found" && exit 1)
          test -f dist/index.js || (echo "âŒ Error: dist/index.js not found" && exit 1)
          test -f dist/index.d.ts || (echo "âŒ Error: dist/index.d.ts not found" && exit 1)
          echo "âœ… All required build artifacts present"

      - name: Test CLI executable
        run: |
          echo "âœ… Testing CLI executable..."
          chmod +x dist/cli.js
          node dist/cli.js --help 2>&1 || true
          echo "âœ… CLI executable test complete"

      - name: Update package version
        run: |
          # Extract version from GitHub release tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "ðŸ“¦ Setting package version to: $VERSION"
          npm version $VERSION --no-git-tag-version

      - name: Publish to npm (with provenance)
        run: npm publish --access public

      - name: Verify npm publication
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "âœ… Published @shaharia-lab/ai-limit-checker@$VERSION to npm"
          echo "ðŸ“¦ Package URL: https://www.npmjs.com/package/@shaharia-lab/ai-limit-checker/v/$VERSION"

      - name: Create GitHub deployment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'npm',
              description: 'Published to npm registry'
            })
