name: Release

on:
  release:
    types: [published]

permissions:
  id-token: write  # Required for OIDC trusted publishing
  contents: read

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Verify npm version for OIDC
        run: |
          echo "ðŸ“‹ Checking npm version..."
          NPM_VERSION=$(npm --version)
          echo "npm version: $NPM_VERSION"
          # npm CLI version 11.5.1 or later is required for OIDC
          if [ "$(printf '%s\n' "11.5.1" "$NPM_VERSION" | sort -V | head -n1)" != "11.5.1" ]; then
            echo "âœ… npm version $NPM_VERSION supports OIDC"
          else
            echo "âŒ npm version $NPM_VERSION does not support OIDC (requires 11.5.1+)"
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Verify build output
        run: |
          echo "âœ… Verifying build artifacts..."
          test -f dist/cli.js || (echo "âŒ Error: dist/cli.js not found" && exit 1)
          test -f dist/index.js || (echo "âŒ Error: dist/index.js not found" && exit 1)
          test -f dist/index.d.ts || (echo "âŒ Error: dist/index.d.ts not found" && exit 1)
          echo "âœ… All required build artifacts present"

      - name: Test CLI executable
        run: |
          echo "âœ… Testing CLI executable..."
          chmod +x dist/cli.js
          node dist/cli.js --help 2>&1 || true
          echo "âœ… CLI executable test complete"

      - name: Update package version
        run: |
          # Extract version from GitHub release tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "ðŸ“¦ Setting package version to: $VERSION"
          npm version $VERSION --no-git-tag-version

      - name: Publish to npm (with provenance)
        run: |
          echo "ðŸ“¦ Publishing to npm..."
          echo "npm config registry: $(npm config get registry)"
          echo "NODE_AUTH_TOKEN: ${NODE_AUTH_TOKEN:+(set)}"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:+(set)}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+(set)}"
          npm publish --access public
          echo "âœ… Published successfully"

      - name: Verify npm publication
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "âœ… Published @shaharia-lab/ai-limit-checker@$VERSION to npm"
          echo "ðŸ“¦ Package URL: https://www.npmjs.com/package/@shaharia-lab/ai-limit-checker/v/$VERSION"

      - name: Create GitHub deployment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'npm',
              description: 'Published to npm registry'
            })
